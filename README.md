# 美股定投策略回测工具

本项目是一个功能全面的美股定投（DCA - Dollar-Cost Averaging）策略回测工具。它允许用户对指定的股票，在特定时间范围内，模拟执行按周或按月的定投策略，并将其表现与一次性全额买入（Lump-Sum）的“躺平”策略进行详细对比。

本项目同时提供了图形化用户界面（GUI）和命令行两种操作模式。

## ✨ 主要功能

- **数据获取**: 使用 `yfinance` 库从雅虎财经实时获取美股历史数据。
- **灵活的定投策略**:
    - 支持 **按周** 或 **按月** 进行定投。
    - 可自定义每周的投资日（周一至周日）。
    - 可自定义每月的投资日（1-31号）。
- **核心回测引擎**:
    - 精确计算在指定时间范围内的总投入、最终资产价值、总收益率和年化收益率。
    - 自动处理节假日和非交易日，将投资操作顺延至下一个有效交易日。
- **"躺平"策略对比**: 将定投策略的结果与在回测期初一次性投入相同总金额的策略进行收益对比。
- **多股票支持**: 支持同时对多个股票进行回测分析和比较。
- **数据可视化**:
    - **投资增长图**: 直观展示总投入成本与总资产价值随时间变化的曲线。
    - **价格与投资点对比图**: 在股价K线图上清晰地标出每一次的定投买入点。
- **图形化界面 (GUI)**:
    - 基于 `PyQt6` 构建了功能完善的图形化操作界面。
    - 用户可通过界面轻松输入股票代码、回测时间范围、投资金额和策略参数。
    - 在界面内嵌的标签页中实时显示回测的文本报告和图表结果。
    - 支持将回测报告导出为文本文件。
- **命令行模式**: 支持在终端中通过交互式问答的方式设置参数并运行回测。
- **单元测试**: 项目包含一套使用 `pytest` 编写的单元测试，确保核心计算逻辑的准确性。

## 项目结构

```
stock_backtest/
├── src/
│   ├── main.py             # 主程序入口，包含命令行逻辑和回测器主类
│   ├── gui.py              # 图形化用户界面 (GUI)
│   ├── data_fetcher.py     # 数据获取模块
│   ├── investment_strategy.py # 定投策略（日期生成）模块
│   ├── backtest.py         # 回测计算核心模块
│   └── visualization.py    # 数据可视化模块
├── tests/
│   ├── test_backtest.py
│   └── test_investment_strategy.py
├── requirements.txt        # 项目依赖库
├── pytest.ini              # Pytest 配置文件
└── README.md               # 本文档
```

## 🚀 如何使用

### 1. 安装依赖

首先，请确保您已安装 Python。然后通过 pip 安装项目所需的依赖库：
```bash
pip install -r requirements.txt
```

### 2. 运行图形化界面 (GUI)

推荐使用图形化界面，功能更直观。
```bash
python stock_backtest/src/gui.py
```

### 3. 运行命令行模式

如果您在无图形界面的环境（如服务器）中，可以使用命令行模式：
```bash
python stock_backtest/src/main.py
```
然后根据终端提示输入回测参数即可。

支持多股票输入，多个股票代码请用逗号分隔，例如：
```bash
AAPL,GOOGL,MSFT
```

### 4. 运行测试

要验证代码的正确性，可以运行单元测试：
```bash
pytest
```